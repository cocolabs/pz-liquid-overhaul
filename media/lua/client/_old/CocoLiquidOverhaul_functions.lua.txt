CLO_Funcs = {
	Utils = {},
	Inventory = {},
	Dispenser = {},
}

-- GetDispenserDispenserOnSquare(square)
-- GetDispenserType(object)
-- SetDispenserType(object, type)
-- DeleteDispenserObject(object)
-- GetDispenserData(object)
-- SetDispenserData(object, current, maximum)

-- UTILS

-- Round a number
function CLO_Funcs.Utils.Round(x)
	return x + 0.5 - (x + 0.5) % 1
end

-- Return hypotenuse
function CLO_Funcs.Utils.Hypo(x, y)
	return math.sqrt(x^2 + y^2)
end

-- Get the distance between two squares
---@param squareA IsoGridSquare
---@param squareB IsoGridSquare
function CLO_Funcs.Utils.GetDistanceBetween(squareA, squareB)
	if not squareA or not squareB then return end

	if squareA:getZ() == squareB:getZ() then
		return CLO_Funcs.Utils.Hypo(squareB:getX() - squareA:getX(), squareB:getY() - squareA:getY())
	end
end

-- Check if player is next to a specific square
---@param playerObj IsoPlayer
---@param squareB IsoGridSquare
function CLO_Funcs.Utils.IsPlayerNextToSquare(playerObj, square, distance)
	if not playerObj or not square then return end
	if not distance then distance = 1.5 end
	return CLO_Funcs.Utils.GetDistanceBetween(playerObj:getCurrentSquare(), square) < distance
end

-- Check if a square contains fuel
---@param square IsoGridSquare
function CLO_Funcs.Utils.IsPetrolAvailableOnSquare(square)
	if not square then return end
	return square:getProperties():Is("fuelAmount")
end

-- Get the amount of fuel available on a square
---@param square IsoGridSquare
function CLO_Funcs.Utils.GetAvailablePetrolOnSquare(square)
	if not square then return end
	if CLO_Funcs.Utils.IsPetrolAvailableOnSquare(square) then
		return tonumber(square:getProperties():Val("fuelAmount"))
	end
	return 0
end

-- Delete an object
---@param obj IsoObject
function CLO_Funcs.Utils.DeleteObject(obj)
	if not obj then return end

	local square = obj:getSquare()
	if square then
		square:transmitRemoveItemFromSquare(obj)
		square:RecalcProperties()
	end
end

-- INVENTORY

-- Get the first item of a type from an inventory
---@param inventory InventoryContainer
---@param type string
function CLO_Funcs.Inventory.GetFirstObjectOfType(inventory, type)
	local result
	local items = inventory:getItems()
	for i = 0, items:size() - 1 do
		local item = items:get(i)
		if item:getType() == type then
			result = item
			break
		end
	end
	return result
end

-- Get the first not empty drainable item of a type from an inventory
---@param inventory InventoryContainer
---@param type string
function CLO_Funcs.Inventory.GetFirstNotEmpty_DrainableItemOfType(inventory, type)
	local result
	local items = inventory:getItems()
	for i = 0, items:size() - 1 do
		---@type InventoryItem
		local item = items:get(i)
		if item:getType() == type and item:IsDrainable() and item:getUsedDelta() > 0 then
			result = item
			break
		end
	end
	return result
end

-- Get the first not full drainable item of a type from an inventory
---@param inventory InventoryContainer
---@param type string
function CLO_Funcs.Inventory.GetFirstNotFull_DrainableItemOfType(inventory, type)
	local result
	local items = inventory:getItems()
	for i = 0, items:size() - 1 do
		---@type InventoryItem
		local item = items:get(i)
		if item:getType() == type and item:IsDrainable() and item:getUsedDelta() < 1 then
			result = item
			break
		end
	end
	return result
end

-- Get the first not empty big water bottle (petrol) from an inventory
---@param inventory InventoryContainer
function CLO_Funcs.Inventory.GetFirstNotEmpty_WaterGallonPetrol(inventory)
	return CLO_Funcs.Inventory.GetFirstNotEmpty_DrainableItemOfType(inventory, "Coco_WaterGallonPetrol")
end

-- Get the first not empty big water bottle (water) from an inventory
---@param inventory InventoryContainer
function CLO_Funcs.Inventory.GetFirstNotEmpty_WaterGallonFull(inventory)
	return CLO_Funcs.Inventory.GetFirstNotEmpty_DrainableItemOfType(inventory, "Coco_WaterGallonFull")
end

-- Get the first not full big water bottle (petrol) from an inventory
---@param inventory InventoryContainer
function CLO_Funcs.Inventory.GetFirstNotFull_WaterGallonPetrol(inventory)
	return CLO_Funcs.Inventory.GetFirstNotFull_DrainableItemOfType(inventory, "Coco_WaterGallonPetrol")
end

-- Get the first not full big water bottle (water) from an inventory
---@param inventory InventoryContainer
function CLO_Funcs.Inventory.GetFirstNotFull_WaterGallonFull(inventory)
	return CLO_Funcs.Inventory.GetFirstNotFull_DrainableItemOfType(inventory, "Coco_WaterGallonFull")
end

-- Get an array of all empty and not full petrol containers from an inventory
---@param inventory InventoryContainer
function CLO_Funcs.Inventory.GetAllPetrolPourableContainer(inventory)
	local result = {}
	local items = inventory:getItems()
	for i = 0, items:size() - 1 do
		local item = items:get(i)
		if item:getType() == "Coco_WaterGallonEmpty" or item:getType() == "EmptyPetrolCan" then
			table.insert(result, item)
		elseif (item:getType() == "Coco_WaterGallonPetrol" or item:getType() == "PetrolCan") and item:getUsedDelta() < 1 then
			table.insert(result, item)
		end
	end
	return result
end

-- DISPENSER

-- Fix any default and custom dispenser
-- Change the max water amount and transform default dispenser into custom
---@param obj IsoObject
function CLO_Funcs.Dispenser.FixWaterDispenser(obj)
	local modData = obj:getModData()
	local objProps = obj:getProperties()
	local customName = objProps:Val("CustomName")

	if customName == "Dispenser" then
		CLO_Funcs.Dispenser.ReplaceDispenserObjectOnSquare(obj, CLO_DispenserTypes.Water)
	end

	--if objProps:Get("CustomName") ~= "empty" then
	--	modData.waterMax = tonumber(CLO_ModSettings.WaterDispenserWaterMax)
	--	if modData.waterAmount then
	--		modData.waterAmount = tonumber(modData.waterAmount)
	--	else
	--		modData.waterAmount = ZombRand(1, modData.waterMax)
	--	end
	--	if modData.waterAmount > modData.waterMax then
	--		modData.waterAmount = modData.waterMax
	--	end
	--end
end

-- Create a dispenser object on a square
-- Use CLO_CustomDispenser.[type].[direction] from the proper sprite image
---@param square IsoGridSquare
---@param spriteName string
function CLO_Funcs.Dispenser.CreateWaterDispenser(square, spriteName)
	if not square then return end

	local obj = IsoObject.new(square, spriteName, "")
	square:AddTileObject(obj)
	CLO_Funcs.Dispenser.FixWaterDispenser(obj)
	return obj
end

-- Delete a dispenser object from a square
---@param square IsoGridSquare
function CLO_Funcs.Dispenser.DeleteDispenserObjectOnSquare(square)
	if not square then return end

	local obj = CLO_Funcs.Dispenser.GetDispenserObjectOnSquare(square)
	if obj then
		CLO_Funcs.Utils.DeleteObject(obj)
		print("Deleting dispenser on square")
	end
end

-- Replace a dispenser with an other type
---@param obj IsoObject
---@param type table use the CLO_CustomDispenser variable
function CLO_Funcs.Dispenser.ReplaceDispenserObjectOnSquare(obj, customDispenser)
	if not obj or not customDispenser then return end

	---@type IsoGridSquare
	local square = obj:getSquare()
	if obj and square then
		local facing = obj:getProperties():Val("Facing")
		CLO_Funcs.Dispenser.CreateWaterDispenser(square, customDispenser[facing])
		CLO_Funcs.Utils.DeleteObject(obj)
	end
end

-- Get a dispenser object if any found on the square
---@param square IsoGridSquare
function CLO_Funcs.Dispenser.GetDispenserObjectOnSquare(square)
	if not square then return end

	local result
	for i = 0, square:getObjects():size() - 1 do
		local obj = square:getObjects():get(i)
		if CLO_Funcs.Dispenser.IsObjectWaterDispenser(obj) then
			result = obj
			break
		end
	end
	return result
end

-- Check if a dispenser is on that square
---@param square IsoGridSquare
function CLO_Funcs.Dispenser.HasDispenserOnSquare(square)
	if not square then return end

	local result = false
	for i = 0, square:getObjects():size() - 1 do
		local obj = square:getObjects():get(i)
		if CLO_Funcs.Dispenser.IsObjectWaterDispenser(obj) then
			result = true
			break
		end
	end
	return result
end

-- Check if the object is a default and custom dispenser
---@param obj IsoObject
function CLO_Funcs.Dispenser.IsObjectWaterDispenser(obj)
	if not obj then return end

	local customName = obj:getProperties():Val("CustomName")
	if customName == "Dispenser" or
			customName == CLO_DispenserTypes.Bottle.type or
			customName == CLO_DispenserTypes.Empty.type or
			customName == CLO_DispenserTypes.Petrol.type or
			customName == CLO_DispenserTypes.Water.type then
		return true
	end
end

-- Check if the dispenser has a bottle or not
---@param obj IsoObject the dispenser object
function CLO_Funcs.Dispenser.IsDispenserEmpty(obj)
	if not obj then return end

	local customName = obj:getProperties():Val("CustomName")
	if CLO_Funcs.Dispenser.IsObjectWaterDispenser(obj) and customName == CLO_DispenserTypes.Empty.type then
		return true
	end
end

-- Check if the dispenser bottle is empty of liquid
---@param obj IsoObject the dispenser object
function CLO_Funcs.Dispenser.IsDispenserBottleEmpty(obj)
	if not obj then return end

	local customName = obj:getProperties():Val("CustomName")
	if CLO_Funcs.Dispenser.IsObjectWaterDispenser(obj) and customName ~= CLO_DispenserTypes.Empty.type then
		return false
	end
end

-- Get the dispenser type object
---@param obj IsoObject the dispenser object
function CLO_Funcs.Dispenser.GetDispenserType(obj)
	if not obj then return end

	local customName = obj:getProperties():Val("CustomName")
	if customName == CLO_DispenserTypes.Water.type then
		return CLO_DispenserTypes.Water
	elseif customName == CLO_DispenserTypes.Petrol.type then
		return CLO_DispenserTypes.Petrol
	elseif customName == CLO_DispenserTypes.Bottle.type then
		return CLO_DispenserTypes.Bottle
	elseif customName == CLO_DispenserTypes.Empty.type then
		return CLO_DispenserTypes.Empty
	end
end

-- Remove the big water bottle of any type from an empty dispenser
-- Add the bottle to inventory
---@param playerObj IsoPlayer the player
---@param obj IsoObject the dispenser to remove the bottle
function CLO_Funcs.Dispenser.RemoveBigWaterBottleFromDispenser(playerObj, obj)
	if not playerObj or not obj then return end

	---@type InventoryContainer
	local inventory = playerObj:getInventory()

	if CLO_Funcs.Dispenser.IsObjectWaterDispenser(obj) and not CLO_Funcs.Dispenser.IsDispenserEmpty(obj) then
		local type
		local modData = obj:getModData()
		local objProps = obj:getProperties()

		local customName = objProps:Val("CustomName")

		if customName == CLO_DispenserTypes.Bottle.type then type = "Coco_WaterGallonEmpty"
		elseif customName == CLO_DispenserTypes.Water.type then type = "Coco_WaterGallonFull"
		elseif customName == CLO_DispenserTypes.Petrol.type then type = "Coco_WaterGallonPetrol" end

		if type ~= nil then

			local square = obj:getSquare()
			local facing = objProps:Val("Facing")

			CLO_Funcs.Dispenser.DeleteDispenserObjectOnSquare(square)
			if facing == "N" then
				CLO_Funcs.Dispenser.CreateWaterDispenser(square, CLO_DispenserTypes.Empty.N)
			elseif facing == "W" then
				CLO_Funcs.Dispenser.CreateWaterDispenser(square, CLO_DispenserTypes.Empty.W)
			elseif facing == "S" then
				CLO_Funcs.Dispenser.CreateWaterDispenser(square, CLO_DispenserTypes.Empty.S)
			elseif facing == "E" then
				CLO_Funcs.Dispenser.CreateWaterDispenser(square, CLO_DispenserTypes.Empty.E)
			end

			local itemName = "CocoLiquidOverhaulItems." .. type
			local addedItem = inventory:AddItem(itemName)
		end

		-- remove liquid
		--modData.waterAmount = 0
		--modData.waterMax = 0
		--modData.petrolAmount = 0
		--modData.petrolMax = 0
	end
end

-- Add a big water bottle of any type to an empty dispenser
-- Take the bottle from inventory
---@param playerObj IsoPlayer the player
---@param obj IsoObject the dispenser to add the bottle to
---@param item InventoryItem the bottle to add
function CLO_Funcs.Dispenser.AddBigWaterBottleFromDispenser(playerObj, obj, item)
	if not playerObj or not obj then return end

	---@type InventoryContainer
	local inventory = playerObj:getInventory()
	local bottleItem = item

	if not instanceof(item, "InventoryItem") and CLO_ModSettings.Debug then
		-- let find an item
		if item == CLO_DispenserTypes.Bottle.type then
			item = CLO_Funcs.Inventory.GetFirstObjectOfType(inventory, "Coco_WaterGallonEmpty")
		elseif item == CLO_DispenserTypes.Water.type then
			item = CLO_Funcs.Inventory.GetFirstNotEmpty_WaterGallonFull(inventory)
		elseif item == CLO_DispenserTypes.Petrol.type then
			item = CLO_Funcs.Inventory.GetFirstNotEmpty_WaterGallonPetrol(inventory)
		end

		if item then
			bottleItem = inventory:AddItem(item)
		end
	end

	if bottleItem and instanceof(bottleItem, "InventoryItem") and CLO_Funcs.Dispenser.IsObjectWaterDispenser(obj) and CLO_Funcs.Dispenser.IsDispenserEmpty(obj) then
		local type
		local itemType = bottleItem:getType()
		local modData = obj:getModData()
		local objProps = obj:getProperties()

		if itemType == "Coco_WaterGallonEmpty" then type = CLO_DispenserTypes.Bottle
		elseif itemType == "Coco_WaterGallonFull" then type = CLO_DispenserTypes.Water
		elseif itemType == "Coco_WaterGallonPetrol" then type = CLO_DispenserTypes.Petrol end

		if type ~= nil then

			local square = obj:getSquare()
			local facing = objProps:Val("Facing")

			CLO_Funcs.Dispenser.DeleteDispenserObjectOnSquare(square)
			if facing == "N" then
				CLO_Funcs.Dispenser.CreateWaterDispenser(square, type.N)
			elseif facing == "W" then
				CLO_Funcs.Dispenser.CreateWaterDispenser(square, type.W)
			elseif facing == "S" then
				CLO_Funcs.Dispenser.CreateWaterDispenser(square, type.S)
			elseif facing == "E" then
				CLO_Funcs.Dispenser.CreateWaterDispenser(square, type.E)
			end

			inventory:Remove(bottleItem)
		end
	end
end
